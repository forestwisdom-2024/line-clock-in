<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡é™¤éŒ¯æ¨¡å¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; word-break: break-all; }
        #debug { background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 12px; }
        .btn { padding: 10px 20px; background: #00b900; color: white; border: none; border-radius: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h3>ğŸ” åƒæ•¸è¨ºæ–·ä¸­</h3>
    
    <div id="debug">æ­£åœ¨è®€å–ç¶²å€...</div>
    <div id="status">æº–å‚™ä¸­...</div>

    <script>
        const debugEl = document.getElementById('debug');
        const statusEl = document.getElementById('status');

        // 1. å¼·åˆ¶å°å‡ºå®Œæ•´ç¶²å€ï¼Œç¢ºèªæœ‰æ²’æœ‰ ?type=clock_in
        const currentURL = window.location.href;
        const searchParams = window.location.search;
        
        // é¡¯ç¤ºåœ¨è¢å¹•ä¸Š
        debugEl.innerHTML = `
            <b>å®Œæ•´ç¶²å€:</b> ${currentURL} <br><br>
            <b>åƒæ•¸éƒ¨åˆ†:</b> ${searchParams || "ç„¡åƒæ•¸"}
        `;

        const urlParams = new URLSearchParams(searchParams);
        const actionType = urlParams.get('type');

        async function main() {
            try {
                await liff.init({ liffId: "2008773653-mSfZM2jC" }); // ç¢ºèª ID æ­£ç¢º
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // é¡¯ç¤ºè®€å–åˆ°çš„çµæœ
                statusEl.innerHTML = `
                    è®€å–åˆ°çš„æ„åœ–: <b>${actionType || 'æœªåµæ¸¬åˆ° (auto)'}</b><br>
                    æ­£åœ¨å®šä½...
                `;

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    await fetch("https://wiselife.zeabur.app/webhook/31ef8052-3ce3-4ca0-893a-71da98525654", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: liff.getContext().userId,
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            source: 'LIFF_AUTO',
                            type: actionType || 'auto'
                        })
                    });
                    statusEl.innerText = "âœ… è³‡æ–™å·²é€å‡º";
                    setTimeout(() => { liff.closeWindow(); }, 3000); // å»¶é•·é—œé–‰æ™‚é–“è®“ä½ çœ‹æ¸…æ¥š
                });

            } catch (err) {
                statusEl.innerText = "éŒ¯èª¤: " + err.message;
            }
        }
        main();
    </script>
</body>
</html>

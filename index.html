<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseLife æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #06C755; --error: #FF4B4B; --warning: #FF9F00; --bg: #F4F6F9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #333; }
        .card { background: #fff; width: 85%; max-width: 400px; padding: 40px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        
        /* å‹•ç•«åœ–ç¤º */
        .icon-box { height: 80px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; font-size: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .success { color: var(--primary); display: none; animation: popIn 0.5s; }
        .error { color: var(--error); display: none; animation: shake 0.5s; }
        .warning { color: var(--warning); display: none; animation: popIn 0.5s; }

        h2 { margin: 0 0 10px 0; font-size: 22px; }
        p { margin: 0 0 20px 0; color: #888; font-size: 14px; line-height: 1.5; white-space: pre-line; } /* pre-line è®“æ›è¡Œç¬¦è™Ÿç”Ÿæ•ˆ */
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div class="card">
        <div class="icon-box">
            <div class="spinner" id="spinner"></div>
            <div class="success" id="iconSuccess">âœ“</div>
            <div class="error" id="iconError">âœ•</div>
            <div class="warning" id="iconWarning">!</div>
        </div>

        <h2 id="title">ç³»çµ±é€£ç·šä¸­...</h2>
        <p id="msg">æ­£åœ¨ç¢ºèªæ‚¨çš„ä½ç½®èˆ‡èº«ä»½</p>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const LIFF_ID = "2008773653-mSfZM2jC"; // ä½ çš„ LIFF ID
        const N8N_URL = "https://wiselife.zeabur.app/webhook/31ef8052-3ce3-4ca0-893a-71da98525654"; 
        
        // --- è®Šæ•¸å€ ---
        const urlParams = new URLSearchParams(window.location.search);
        const actionType = urlParams.get('type') || 'auto';
        
        const uiTitle = document.getElementById('title');
        const uiMsg = document.getElementById('msg');
        const uiSpinner = document.getElementById('spinner');

        // è¨­å®šåˆå§‹æ¨™é¡Œ
        if (actionType === 'clock_in') uiTitle.innerText = "â˜€ï¸ æ­£åœ¨æ‰“ä¸Šç­å¡";
        else if (actionType === 'clock_out') uiTitle.innerText = "ğŸŒ™ æ­£åœ¨æ‰“ä¸‹ç­å¡";
        else uiTitle.innerText = "ğŸ“ è‡ªå‹•æ‰“å¡ä¸­";

        async function main() {
            try {
                // 1. åˆå§‹åŒ–
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }

                uiMsg.innerText = "æ­£åœ¨å–å¾— GPS å®šä½...";

                // 2. å®šä½
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    uiMsg.innerText = "æ­£åœ¨èˆ‡ä¼ºæœå™¨é€šè¨Š...";

                    // 3. å‘¼å« n8n (å¾Œç«¯åˆ¤æ–·)
                    const response = await fetch(N8N_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: liff.getContext().userId,
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            source: 'LIFF_AUTO',
                            type: actionType
                        })
                    });

                    // 4. è§£æ n8n å›å‚³çš„åˆ¤æ±º (JSON)
                    const result = await response.json(); 
                    // result æ ¼å¼: { status: "success/error/warning", message: "...", lat: ..., lng: ... }

                    // 5. æ ¹æ“šåˆ¤æ±ºåŸ·è¡Œå‹•ä½œ
                    handleResult(result);

                }, (err) => {
                    showUI('error', "å®šä½å¤±æ•—", "è«‹ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿã€‚");
                }, { enableHighAccuracy: true });

            } catch (err) {
                showUI('error', "ç³»çµ±éŒ¯èª¤", err.message);
            }
        }

        // --- æ ¸å¿ƒäº’å‹•é‚è¼¯ ---
        async function handleResult(data) {
            
            // æº–å‚™è¦ç™¼é€çµ¦èŠå¤©å®¤çš„è¨Šæ¯é™£åˆ—
            let messagesToSend = [];

            if (data.status === 'success') {
                showUI('success', "æ‰“å¡æˆåŠŸ", data.message);
                messagesToSend.push({ type: 'text', text: "âœ… " + data.message });
            } 
            else if (data.status === 'warning') {
                showUI('warning', "æ³¨æ„", data.message);
                // è­¦å‘Šè¨Šæ¯ä¹Ÿç™¼é€å›èŠå¤©å®¤ (ä¾‹å¦‚é‡è¤‡æ‰“å¡)
                messagesToSend.push({ type: 'text', text: data.message });
            } 
            else { // error (ä¾‹å¦‚è·é›¢å¤ªé )
                showUI('error', "æ‰“å¡å¤±æ•—", data.message);
                messagesToSend.push({ type: 'text', text: data.message });
                
                // å¦‚æœæœ‰åº§æ¨™ï¼Œå¤šå‚³é€ä¸€å¼µåœ°åœ–çµ¦ä½¿ç”¨è€…çœ‹
                if (data.lat && data.lng) {
                    messagesToSend.push({
                        type: 'location',
                        title: 'æ‰“å¡ä½ç½®',
                        address: 'ç³»çµ±åµæ¸¬åˆ°çš„ä½ç½®',
                        latitude: data.lat,
                        longitude: data.lng
                    });
                }
            }

            // 6. åŸ·è¡Œ LIFF ç™¼é€ (å…è²» API)
            try {
                if (liff.isInClient()) {
                    await liff.sendMessages(messagesToSend);
                }
            } catch (err) {
                console.error("ç™¼é€è¨Šæ¯å¤±æ•—", err);
                // å³ä½¿ç™¼é€å¤±æ•—ï¼Œç•«é¢å·²ç¶“é¡¯ç¤ºçµæœï¼Œæ‰€ä»¥ä¸å½±éŸ¿æµç¨‹
            }

            // 7. è‡ªå‹•é—œé–‰
            setTimeout(() => { liff.closeWindow(); }, 2500);
        }

        // --- UI åˆ‡æ› ---
        function showUI(type, title, msg) {
            uiSpinner.style.display = 'none';
            uiTitle.innerText = title;
            uiMsg.innerText = msg;
            
            document.getElementById('iconSuccess').style.display = 'none';
            document.getElementById('iconError').style.display = 'none';
            document.getElementById('iconWarning').style.display = 'none';

            if (type === 'success') {
                document.getElementById('iconSuccess').style.display = 'block';
                uiTitle.style.color = "var(--primary)";
            } else if (type === 'warning') {
                document.getElementById('iconWarning').style.display = 'block';
                uiTitle.style.color = "var(--warning)";
            } else {
                document.getElementById('iconError').style.display = 'block';
                uiTitle.style.color = "var(--error)";
            }
        }

        window.onload = main;
    </script>
</body>
</html>
